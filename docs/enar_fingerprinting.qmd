---
title: "Walking Fingerprinting Using Wrist Accelerometry during Activities of Daily Living in NHANES"
title-slide-attributes:
    data-background-image: figs/qr_url.png
    data-background-size: 20%
    data-background-position: 90% 90%
subtitle: ""
author: "Lily Koffman"
institute: "Department of Biostatistics, Johns Hopkins School of Public Health" 
format:
  revealjs:
    theme: custom.scss
    slide-number: true
    toc: false
    progress: true
    hash: true
    overview: true
    code-overflow: wrap
    code-line-numbers: false
    center: false
    width: 1400
    height: 850
    html-math-method: mathjax
    embed-resources: true
    logo: figs/bsph.shield.rgb.black.svg
    footer: tinyurl.com/koff-enar25
code: 
  echo: false
  cache: true 
editor_options: 
  chunk_output_type: console
bibliography: references.bib
---

```{r load packages}
#| include: false 

library(patchwork)
library(tidyverse)
library(ggridges)
library(paletteer)
library(viridis)
library(geomtextpath)
library(showtext)
library(scales)
library(ggplot2)
library(ggrepel)
library(broom)
library(mgcv)
library(survival)
library(ggimage)
library(cowplot)
options(digits.secs = 3)

```

```{r misc functions}
#| include: false 

# https://brand.jhu.edu/visual-identity/colors/
range_left = function(x, left, right){
  ifelse(x > left & x <= right, TRUE, FALSE)
}

get_density = function(x, y, ...) {
  dens <- MASS::kde2d(x, y, ...)
  ix <- findInterval(x, dens$x)
  iy <- findInterval(y, dens$y)
  ii <- cbind(ix, iy)
  return(dens$z[ii])
}

make_plot = function(id){
  wdf = read_rds(here::here("results", "pred_dfs", paste0(id, "_raw_vm.rds"))) %>%
    mutate(train = if_else(train == TRUE, "train", "test"))

  dens_df =
    map_dfr(.x = c(12, 24, 36),
            .f = function(df, lg){
              df %>%
                select(second_id, train, vm) %>%
                group_by(train, second_id) %>%
                mutate(lag_vm = lag(vm, n = lg)) %>%
                ungroup() %>%
                drop_na() %>%
                mutate(lag = lg)
            },
            df = wdf)
  dens_df =
    dens_df %>%
    # group_by(lag, second_id, train) %>%
    group_by(lag, train) %>%
    mutate(density = get_density(vm, lag_vm, n = 80)) %>%
    ungroup()


  p = dens_df %>%
    mutate(train = factor(train, levels = c("train", "test"), labels = c("Training data","Testing data")),
           lag = case_when(lag == 12 ~ "Lag = 0.15s",
                           lag == 24 ~ "Lag = 0.30s",
                           .default = "Lag = 0.45s")) %>%
    ggplot(aes(x = vm, y = lag_vm, color = density)) +
    geom_point(size= 1, alpha= .9) +
    facet_grid(lag~train) +
    viridis::scale_color_viridis(option = "B") +
    labs(title = paste0("Participant ", id)) +
    scale_y_continuous(limits=c(0, 3)) +
    scale_x_continuous(limits=c(0, 3)) +
    theme(legend.position = "none", panel.grid = element_blank()) +
    labs(x = "Acceleration (g)", y = "Lag Acceleration (g)")

    return(p)
}


```

```{r ggplot theme}
#| include: false  

okabe_ito <- c(
  "#000000", "#CBA052", "#4E97E0", "#008767", "#86C8BC", 
  "#F1C400", "#002D72", "#F56600", "#A45C98"
)


showtext_auto()
font_add_google("Source Sans Pro", "Source Sans Pro")

# JHU palette (subset)
jhu_primary <- c(
  heritage_blue = "#002D72",
  spirit_blue   = "#68ACE5",
  medium_blue   = "#0077D8",
  harbor_blue   = "#4E97E0",
  gold          = "#F1C400"
)

theme_set(
  theme_minimal(base_family = "Source Sans Pro") +
    theme(
      plot.background = element_rect(fill = "white", color = NA),
      panel.background = element_rect(fill = "white", color = NA),

      panel.grid.major = element_line(color = "#E6E6E6"),
      panel.grid.minor = element_blank(),

      axis.text = element_text(color = "#31261D", size = 12),
      axis.title = element_text(color = "#31261D", size = 14),

      plot.title = element_text(
        face = "bold",
        size = 18,
        color = jhu_primary["spirit_blue"]
      ),
      plot.subtitle = element_text(
        size = 14,
        color = "#444444"
      ),

      strip.background = element_rect(
        fill = jhu_primary["heritage_blue"],
        color = NA
      ),
      strip.text = element_text(color = "white", size = 12),

      legend.title = element_text(color = "#31261D"),
      legend.text = element_text(color = "#31261D")
    )
)

# Discrete scales
scale_color_jhu <- function(...) {
  scale_color_manual(
    values = unname(jhu_primary[c("medium_blue", "harbor_blue", "spirit_blue", "gold")]),
    ...
  )
}

scale_fill_jhu <- function(...) {
  scale_fill_manual(
    values = unname(jhu_primary[c("medium_blue", "harbor_blue", "spirit_blue", "gold")]),
    ...
  )
}


```


```{r data read in and processing}
#| cache: true 
#| include: false

# --- accel data ----- # 
walking = read_rds(here::here("data", "walking.rds"))
driving = read_rds(here::here("data", "driving.rds"))
cooking = read_rds(here::here("data", "cooking.rds"))


# --- nh fprint ---- # 
dens_df = read_rds(here::here("data", "dens_temp_df.rds")) 
sample_dat2 = read_rds(here::here("data", "fingerprint_data_sample_temporal.rds"))

# --- nhanes segments --- # 
segments = read_csv(here::here("data", "walking_segments.csv.gz"))
segments_sc = read_csv(here::here("data", "walking_segments_sc.csv.gz"))

# ---- accel data ---- # 

data = read_csv(here::here("data", "df_all_IU.csv"))

iu_dat =
  data %>%
  rename(vm = signal_lw)

df =
  iu_dat %>%
  filter(between(time, 200, 201), ID2 == 4) %>%
  mutate(lag_vm = lag(vm, n = 15)) %>%
  mutate(time = time - min(time))

df30 =
  iu_dat %>%
  filter(between(time, 200, 201), ID2 == 4) %>%
  mutate(lag_vm = lag(vm, n = 30)) %>%
  mutate(time = time - min(time))

df2 =
  iu_dat %>%
  filter(between(time, 201, 202), ID2 == 4) %>%
  mutate(lag_vm = lag(vm, n = 15)) %>%
  mutate(time = time - min(time))

df2_30 =
  iu_dat %>%
  filter(between(time, 201, 202), ID2 == 4) %>%
  mutate(lag_vm = lag(vm, n = 30)) %>%
  mutate(time = time - min(time))

df3 =
  iu_dat %>%
  filter(between(time, 101, 102), ID2 == 2) %>%
  mutate(lag_vm = lag(vm, n = 15)) %>%
  mutate(time = time - min(time))

df3_30 =
  iu_dat %>%
  filter(between(time, 101, 102), ID2 == 2) %>%
  mutate(lag_vm = lag(vm, n = 30)) %>%
  mutate(time = time - min(time))

df3_302 =
  iu_dat %>%
  filter(between(time, 102, 103), ID2 == 2) %>%
  mutate(lag_vm = lag(vm, n = 30)) %>%
  mutate(time = time - min(time))

df3_152 =
  iu_dat %>%
  filter(between(time, 102, 103), ID2 == 2) %>%
  mutate(lag_vm = lag(vm, n = 15)) %>%
  mutate(time = time - min(time))

df4 =
  iu_dat %>%
  filter(between(time, 201, 202), ID2 == 6) %>%
  mutate(lag_vm = lag(vm, n = 15)) %>%
  mutate(time = time - min(time))

# ------- densities -------- # 
dens_df_s2_l15 =
  iu_dat %>%
  filter(ID2 == 2) %>% 
  mutate(time = (row_number() / 100) - 0.01) %>%
  mutate(s = floor(time)) %>%
  filter(s <= 240) %>%
  group_by(s) %>%
  mutate(lag_vm = lag(vm, n = 15)) %>%
  ungroup()  %>%
  drop_na()

dens_df_s2_l15$density = get_density(dens_df_s2_l15$vm, dens_df_s2_l15$lag_vm, n = 100)

dens_df_s2_l30 =
  iu_dat %>%
  filter(ID2 == 2) %>% 
  mutate(time = (row_number() / 100) - 0.01) %>%
  mutate(s = floor(time)) %>%
  filter(s <= 240) %>%
  group_by(s) %>%
  mutate(lag_vm = lag(vm, n = 30)) %>%
  ungroup()  %>%
  drop_na()

dens_df_s2_l30$density = get_density(dens_df_s2_l30$vm, dens_df_s2_l30$lag_vm, n = 100)

dens_df_s4_l15 =
  iu_dat %>%
  filter(ID2 == 4) %>% 
  mutate(time = (row_number() / 100) - 0.01) %>%
  mutate(s = floor(time)) %>%
  filter(s <= 240) %>%
  group_by(s) %>%
  mutate(lag_vm = lag(vm, n = 15)) %>%
  ungroup()  %>%
  drop_na()

dens_df_s4_l15$density = get_density(dens_df_s4_l15$vm, dens_df_s4_l15$lag_vm, n = 100)

dens_df_s4_l30 =
  iu_dat %>%
  filter(ID2 == 4) %>% 
  mutate(time = (row_number() / 100) - 0.01) %>%
  mutate(s = floor(time)) %>%
  filter(s <= 240) %>%
  group_by(s) %>%
  mutate(lag_vm = lag(vm, n = 30)) %>%
  ungroup()  %>%
  drop_na()

dens_df_s4_l30$density = get_density(dens_df_s4_l30$vm, dens_df_s4_l30$lag_vm, n = 100)

dens_df_s6_l15 =
  iu_dat %>%
  filter(ID2 == 6) %>% 
  mutate(time = (row_number() / 100) - 0.01) %>%
  mutate(s = floor(time)) %>%
  filter(s <= 240) %>%
  group_by(s) %>%
  mutate(lag_vm = lag(vm, n = 15)) %>%
  ungroup()  %>%
  drop_na()

dens_df_s6_l15$density = get_density(dens_df_s6_l15$vm, dens_df_s6_l15$lag_vm, n = 100)

dens_df_s6_l30 =
  iu_dat %>%
  filter(ID2 == 6) %>% 
  mutate(time = (row_number() / 100) - 0.01) %>%
  mutate(s = floor(time)) %>%
  filter(s <= 240) %>%
  group_by(s) %>%
  mutate(lag_vm = lag(vm, n = 30)) %>%
  ungroup()  %>%
  drop_na()

dens_df_s6_l30$density = get_density(dens_df_s6_l30$vm, dens_df_s6_l30$lag_vm, n = 100)

### more densities 

get_dens = function(lag_tmp, id = 2){
  dd =
    iu_dat %>%
    filter(ID2 == id) %>% 
    mutate(time = (row_number() / 100) - 0.01) %>%
    mutate(s = floor(time)) %>%
    filter(s <= 240) %>%
    group_by(s) %>%
    mutate(lag_vm = lag(vm, n = lag_tmp)) %>%
    ungroup()  %>%
    drop_na()
  
  dd$density = get_density(dd$vm, dd$lag_vm, n = 100)
  return(dd %>% mutate(lag = lag_tmp))
}

dens_res = map_dfr(.x = seq(5, 99, 10),
                   .f = get_dens) %>% 
  mutate(lag = lag / 100) %>% 
  mutate(across(c(vm, lag_vm), ~if_else(.x > 3 | .x < 0, NA, .x)))

dens_res6 = map_dfr(.x = seq(5, 99, 10),
                   .f = get_dens,
                   id = 6) %>% 
  mutate(lag = lag / 100) %>% 
  mutate(across(c(vm, lag_vm), ~if_else(.x > 3 | .x < 0, NA, .x)))


get_dens2 = function(lag_tmp){
  dd =
    iu_dat %>%
    filter(ID2 == 2) %>% 
    mutate(time = (row_number() / 100) - 0.01) %>%
    mutate(s = floor(time)) %>%
    filter(s <= 1) %>%
    group_by(s) %>%
    mutate(lag_vm = lag(vm, n = lag_tmp)) %>%
    ungroup()  %>%
    drop_na()
  
  dd$density = get_density(dd$vm, dd$lag_vm, n = 100)
  return(dd %>% mutate(lag = lag_tmp))
}

dens_res2 = map_dfr(.x = seq(1, 99, 1),
                   .f = get_dens2) %>% 
  mutate(lag = lag / 100)

dens_res2 = 
  dens_res2 %>% 
  mutate(across(c(vm, lag_vm), ~if_else(.x > 3 | .x < 0, NA, .x)))

dd1 =
  iu_dat %>%
  filter(ID2 == 2) %>% 
  mutate(time = (row_number() / 100) - 0.01) %>%
  mutate(s = floor(time)) %>%
  filter(s <= 240) %>%
  group_by(s) %>%
  mutate(lag_vm = lag(vm, n = 1)) %>%
  ungroup()  %>%
  drop_na()

dd1$density = get_density(dd1$vm, dd1$lag_vm, n = 100)

dd2 =
  iu_dat %>%
  filter(ID2 == 2) %>% 
  mutate(time = (row_number() / 100) - 0.01) %>%
  mutate(s = floor(time)) %>%
  filter(s <= 240) %>%
  group_by(s) %>%
  mutate(lag_vm = lag(vm, n = 2)) %>%
  ungroup()  %>%
  drop_na()

dd2$density = get_density(dd2$vm, dd2$lag_vm, n = 100)

dd50 =
  iu_dat %>%
  filter(ID2 == 2) %>% 
  mutate(time = (row_number() / 100) - 0.01) %>%
  mutate(s = floor(time)) %>%
  filter(s <= 240) %>%
  group_by(s) %>%
  mutate(lag_vm = lag(vm, n = 50)) %>%
  ungroup()  %>%
  drop_na()

dd50$density = get_density(dd50$vm, dd50$lag_vm, n = 100)

dd99 =
  iu_dat %>%
  filter(ID2 == 2) %>% 
  mutate(time = (row_number() / 100) - 0.01) %>%
  mutate(s = floor(time)) %>%
  filter(s <= 240) %>%
  group_by(s) %>%
  mutate(lag_vm = lag(vm, n = 99)) %>%
  ungroup()  %>%
  drop_na()

dd99$density = get_density(dd99$vm, dd99$lag_vm, n = 100)



```

```{r model results processing}
#| cache: true
#| include: false 

### accuracies for n=100,n=500

res_100 = c(list.files(here::here("results"), pattern = "*.\\_100.rds"),
            list.files(here::here("results"), pattern = "*.\\_100fnl.rds"),
            list.files(here::here("results"), pattern = "*.\\_100nlfnl.rds"),
            list.files(here::here("results"), pattern = "*.\\_100lasso.rds"),
            list.files(here::here("results"), pattern = "*.\\_100xgb.rds"),
            list.files(here::here("results"), pattern = "*.\\_100rf.rds"))

all_100 =
  map_dfr(res_100,
          .f = function(x){
            read_rds(here::here("results", x)) %>%
              mutate(name = x)
          }) %>%
  mutate(
    type = case_when(
      sub(".*\\d(.+).rds.*", "\\1", name) == "xgb" ~ "XGBoost",
      sub(".*\\d(.+).rds.*", "\\1", name) == "long" ~ "Long",
      sub(".*\\d(.+).rds.*", "\\1", name) == "lasso" ~ "Lasso",
      sub(".*\\d(.+).rds.*", "\\1", name) == "rf" ~ "Random Forest",
      sub(".*\\d(.+).rds.*", "\\1", name) == "fnl" ~ "Linear SoFR",
      sub(".*\\d(.+).rds.*", "\\1", name) == "nlfnl" ~ "Nonlinear SoFR",
      .default = "Logistic"
    ),
    paradigm = case_when(
      grepl("temporal2", name) ~ "temporal2",
      grepl("temporal", name) ~ "temporal",
      .default = "random"
    )
  ) %>%
  filter(paradigm != "temporal")


res_500 = c(list.files(here::here("results"), pattern = "*.\\_500.rds"),
            list.files(here::here("results"), pattern = "*.\\_500fnl.rds"),
            list.files(here::here("results"), pattern = "*.\\_500nlfnl.rds"),
            list.files(here::here("results"), pattern = "*.\\_500lasso.rds"),
            list.files(here::here("results"), pattern = "*.\\_500xgb.rds"),
            list.files(here::here("results"), pattern = "*.\\_500rf.rds"))

all_500 =
  map_dfr(res_500,
          .f = function(x){
            read_rds(here::here("results", x)) %>%
              mutate(name = x) %>%
              mutate(fold = as.numeric(fold))
          }) %>%
  mutate(
    type = case_when(
      sub(".*\\d(.+).rds.*", "\\1", name) == "xgb" ~ "XGBoost",
      sub(".*\\d(.+).rds.*", "\\1", name) == "long" ~ "Long",
      sub(".*\\d(.+).rds.*", "\\1", name) == "lasso" ~ "Lasso",
      sub(".*\\d(.+).rds.*", "\\1", name) == "rf" ~ "Random Forest",
      sub(".*\\d(.+).rds.*", "\\1", name) == "fnl" ~ "Linear SoFR",
      sub(".*\\d(.+).rds.*", "\\1", name) == "nlfnl" ~ "Nonlinear SoFR",
      .default = "Logistic"
    ),
    paradigm = case_when(
      grepl("temporal2", name) ~ "temporal2",
      grepl("temporal", name) ~ "temporal",
      .default = "random"
    )
  ) %>%
  filter(paradigm != "temporal")



res_logistic = c(list.files(here::here("results"), pattern = "*.\\_100.rds"),
                 list.files(here::here("results"), pattern = "*.\\_500.rds"),
                 list.files(here::here("results"), pattern = "*.\\_1000.rds"),
                 list.files(here::here("results"), pattern = "*.\\_2500.rds"),
                 list.files(here::here("results"), pattern = "*.\\_5000.rds"),
                 list.files(here::here("results"), pattern = "*.\\_10000.rds"),
                 list.files(here::here("results"), pattern = "*.\\_13367.rds"),
                 list.files(here::here("results"), pattern = "*.\\_10770.rds"))

res_logistic_t2 = res_logistic[grepl("temporal2", res_logistic)]
res_logistic = res_logistic[!grepl("temporal", res_logistic)]

res_logistic = res_logistic[!grepl("sc", res_logistic)]

res_logistic = c(res_logistic, res_logistic_t2)
all_logistic =
  map_dfr(res_logistic,
          .f = function(x){
            read_rds(here::here("results", x)) %>%
              mutate(name = x) %>%
              mutate(fold = as.numeric(fold))
          }) %>%
  mutate(
    type = case_when(
      sub(".*\\d(.+).rds.*", "\\1", name) == "xgb" ~ "XGBoost",
      sub(".*\\d(.+).rds.*", "\\1", name) == "long" ~ "Long",
      sub(".*\\d(.+).rds.*", "\\1", name) == "lasso" ~ "Lasso",
      sub(".*\\d(.+).rds.*", "\\1", name) == "rf" ~ "Random Forest",
      sub(".*\\d(.+).rds.*", "\\1", name) == "fnl" ~ "Linear SoFR",
      sub(".*\\d(.+).rds.*", "\\1", name) == "nlfnl" ~ "Nonlinear SoFR",
      .default = "Logistic"
    ),
    paradigm = case_when(
      grepl("temporal2", name) ~ "temporal2",
      grepl("temporal", name) ~ "temporal",
      .default = "random"
    )
  ) %>%
  filter(paradigm != "temporal") %>%
  mutate(across(starts_with("rank"), ~.x / n * 100))

```

## Introduction: accelerometry data 

```{r accel plot}
#| cache: true
img_plot = ggplot() +
  ggimage::geom_image(aes(x = 0.5, y = 0.5, image = here::here("docs/figs/actigraph.png")), size = 1) +
  theme_void() + 
  theme(
      plot.background = element_rect(fill = "#FFFFFF", color = NA),
      panel.background = element_rect(fill = "#FFFFFF", color = NA)
    )


p1 = 
  driving %>% 
  ggplot(aes(x = t, y = vm))+
  geom_line(linewidth = 0.9, color = "#002D72")+
  theme(panel.grid.minor = element_blank()) +
  labs(x = "Time (s)", y = "Acceleration (g = 9.81m/s²)") +
  scale_x_continuous(breaks=seq(0,10,1)) +
  scale_y_continuous(limits = c(0.5, 1.75)) + 
  annotate(geom = "label", x = 5, y = 1.5, label = "Driving (passenger)", size = 8, color = "#002D72")

p2 = 
  cooking %>% 
  ggplot(aes(x = t, y = vm))+
  geom_line(linewidth = 0.9, color = "#008767")+
  theme(panel.grid.minor = element_blank()) +
  labs(x = "Time (s)", y = "Acceleration (g = 9.81m/s²)") +
  scale_x_continuous(breaks=seq(0,10,1)) +
  scale_y_continuous(limits = c(0.5, 1.75)) +
  annotate(geom = "label", x = 5, y = 1.5, label = "Cooking", size = 8, color = "#008767")


p3 = 
  walking %>% 
  ggplot(aes(x = t, y = vm))+
  geom_line(linewidth = 0.9, color = "#A45C98")+
  theme(panel.grid.minor = element_blank()) +
  labs(x = "Time (s)", y = "Acceleration (g = 9.81m/s²)") +
  scale_x_continuous(breaks = seq(0,10,1)) + 
  scale_y_continuous(limits = c(0.5, 1.75)) +
  annotate(geom = "label", x = 5, y = 1.5, label = "Walking", size = 8, color = "#A45C98")



plot_grid(img_plot, NULL, align = "v", rel_widths = c(1,1), ncol = 2)
```

## Introduction: accelerometry data 

```{r accel plot w fig}
#| cache: true


p1a = p1 / p2 / p3 + plot_layout(guides = "collect", axes = "collect")

plot_grid(img_plot, p1a, align = "v", rel_widths = c(1,1), ncol = 2)
```

## Introduction: **big** accelerometry data 

```{r accel plot nhanes}
#| cache: true
nh_img_plot = ggplot() +
  ggimage::geom_image(aes(x = 0.5, y = 0.5, image = here::here("docs/figs/nhanes.png")), size = 1) +
  theme_void() + 
  theme(
      plot.background = element_rect(fill = "#FFFFFF", color = NA),
      panel.background = element_rect(fill = "#FFFFFF", color = NA)
    )



p3_annotated = p3 + plot_annotation(
  caption = "80 observations per second\n× 60 seconds/minute\n× 1440 minutes/day\n× 7 days\n× 15,000 individuals\n=726 billion data points",
  theme = theme(
    plot.caption = element_text(
      hjust = 0.5,            # center the text
      vjust = 1,              # bring it up a bit
      size = 14,              # large and clear
      face = "bold",          # prominent
      family = "Source Sans Pro",
      color = "black",        # use a strong color
      lineheight = 1.1        # control spacing between lines
    ),
    plot.background = element_rect(fill = "#FFFFFF", color = NA)
  )
  )

final_plot = nh_img_plot + 
  wrap_elements(p3_annotated) + 
  plot_layout(widths = c(1, 1), heights = c(1))

final_plot
```


# Can we identify someone from their walking pattern measured by a wrist-worn accelerometer?
  


---

### Problem setup 


```{r accel problem setup}
#| cache: true
s1 = data %>% 
  filter(ID2 %in% c(2, 4, 6, 8, 9)) 

ymax = s1 %>% 
  filter(ID2 %in% c(2, 4, 6)) %>% 
  filter(time >= 20 & time < 30) %>% 
  pull(signal_lw) %>% 
  max()
  
ymin = s1 %>% 
  filter(ID2 %in% c(2, 4, 6)) %>% 
  filter(time >= 20 & time < 30) %>% 
  pull(signal_lw) %>% 
  min()  

label_df = 
  s1 %>% 
  filter(ID2 %in% c(2, 4, 6)) %>% 
  filter(time >= 20 & time < 30) %>% 
  mutate(ID2 = factor(ID2, labels = c("Person A", "Person B", "Person C"))) %>% 
  filter(time == 25) %>% 
  mutate(signal_lw = 2.5)

p1 =
  s1 %>% 
  filter(ID2 %in% c(2, 4, 6)) %>% 
  filter(time >= 20 & time < 30) %>% 
  mutate(ID2 = factor(ID2, labels = c("Person A", "Person B", "Person C"))) %>%
  ggplot(aes(x = time, y = signal_lw, color = ID2)) +
  geom_line(linewidth = 1) + 
  facet_wrap(.~ID2, ncol = 1) + 
  scale_color_manual(values = c("#CBA052", "#4E97E0", "#008767")) +
  labs(x = "Time (s)", y = "Acceleration (g)") + 
  theme(legend.position = "none",
        panel.spacing = unit(0.1, "lines"), # tighten vertical spacing
        strip.text = element_blank(),
        strip.background = element_blank()) +
  scale_x_continuous(breaks=seq(20, 30, 2), labels= seq(0,10,2)) + 
  geom_label(data = label_df, aes(color = ID2, label = ID2), size = 8, show.legend = FALSE)


label_df2 = 
  s1 %>% 
  filter(ID2 %in% c(6, 8, 9)) %>% 
  filter(time >= 30 & time < 40) %>% 
  mutate(ID2 = factor(ID2, labels = c("Person ?", "Person ??", "Person ???"))) %>%
  filter(time == 35) %>% 
  mutate(signal_lw = 2.5)


p2 =
  s1 %>% 
  filter(ID2 %in% c(6, 8, 9)) %>% 
  filter(time >= 30 & time < 40) %>% 
  mutate(ID2 = factor(ID2, labels = c("Person ?", "Person ??", "Person ???"))) %>%
  ggplot(aes(x = time, y = signal_lw, color = ID2)) +
  geom_line(linewidth = 1) + 
  facet_wrap(.~ID2, ncol = 1) + 
  scale_color_manual(values = c("#F56600","#A45C98", "#000000")) +
  labs(x = "Time (s)", y = "Acceleration (g)") + 
  theme(legend.position = "none",
        panel.spacing = unit(0.1, "lines"), # tighten vertical spacing
        strip.text = element_blank(),
        strip.background = element_blank()) +
  scale_x_continuous(breaks=seq(30, 40, 2), labels= seq(0,10,2)) + 
  scale_y_continuous(limits=c(ymin, ymax)) +
  geom_label(data = label_df2, aes(color = ID2), label = "?", size = 8, show.legend = FALSE)


label_df3 = 
  s1 %>% 
  filter(ID2 %in% c(6, 8, 9)) %>% 
  filter(time >= 30 & time < 40) %>% 
  mutate(ID2 = factor(ID2, labels = c("Person C", "Person D", "Person E"))) %>%
  filter(time == 35) %>% 
  mutate(signal_lw = 2.5)

p3 =
  s1 %>% 
  filter(ID2 %in% c(6, 8, 9)) %>% 
  filter(time >= 30 & time < 40) %>% 
  mutate(ID2 = factor(ID2, labels = c("Person C", "Person D", "Person E"))) %>%
  ggplot(aes(x = time, y = signal_lw, color = ID2)) +
  geom_line(linewidth = 1) + 
  facet_wrap(.~ID2, ncol = 1) + 
  scale_color_manual(values = c("#008767","#A45C98", "#000000")) +
  labs(x = "Time (s)", y = "Acceleration (g)") + 
  theme(legend.position = "none",
        panel.spacing = unit(0.1, "lines"), # tighten vertical spacing
        strip.text = element_blank(),
        strip.background = element_blank()) +
  scale_x_continuous(breaks=seq(30, 40, 2), labels= seq(0,10,2)) + 
  scale_y_continuous(limits=c(ymin, ymax)) +
  geom_label(data = label_df3, aes(color = ID2, label = ID2), size = 8, show.legend = FALSE)

p_empty =
  s1 %>% 
  filter(ID2 %in% c(6, 8, 9)) %>% 
  filter(time >= 30 & time < 40) %>% 
  mutate(ID2 = factor(ID2, labels = c("Person C", "Person D", "Person E"))) %>%
  ggplot(aes(x = time, y = signal_lw, color = ID2)) +
  scale_x_continuous(breaks=seq(30, 40, 2), labels= seq(0,10,2)) + 
  theme_void() +
  theme(panel.background = element_rect(fill = "#ffffff", color = NA),
        plot.background = element_rect(fill = "#FFFFFF", color = NA))



# p1 + p_empty + plot_layout(widths = c(1, 1))
plot_grid(p1, p_empty, ncol = 2, align = "v", rel_widths = c(1,1))

```

---

### Problem setup 

```{r fingerprint question 2}
#| cache: true
# p1 + p2 + plot_layout(widths = c(1, 1))

plot_grid(p1, p2, ncol = 2, align = "v", rel_widths = c(1,1))

```

---

### Problem setup 

```{r fingerprint answer}
plot_grid(p1, p3, ncol = 2, align = "v", rel_widths = c(1,1))
```


---

### Big picture method: time series to scalar predictors

```{r def arrow}
arrow_plot = ggplot() +
  xlim(0,1) + ylim(0,1) +
  annotate(
    "segment",
    x = 0, xend = 1, y = 0.5, yend = 0.5,
    arrow = arrow(length = unit(0.2, "inches"), type = "closed"),
    color = "#F56600", linewidth = 1.5
  ) +
  theme_void() +
  theme(plot.background = element_rect(fill = "#FFFFFF"))
```

```{r x matrix}
#| cache: true
n_rows = 15
n_cols = 10

# Create a dummy data frame for tiles
pred_matrix = expand_grid(
  row = 1:n_rows,
  col = 1:n_cols
) %>% 
  mutate(subj = 
           case_when(row %in% c(1:5) ~ 1,
                     row %in% c(6:10) ~ 2,
                     TRUE ~ 3)) %>% 
  rowwise() %>% 
  mutate(alpha = runif(1, 0, 1)) %>% 
  ungroup()


# Bracket offsets
vert_extend = 1.0   # how far the vertical line extends beyond top/bottom
hor_arm = 0.4       # horizontal arm length

# Left bracket `[`
left_bracket = tibble(
  # vertical line
  x = 0.5 - 0.3, xend = 0.5 - 0.3,
  y = 0.5 - vert_extend, yend = n_rows + 0.5 + vert_extend,
  # top horizontal
  x_top = 0.5 - 0.3, xend_top = 0.5 - 0.3 + hor_arm,
  y_top = n_rows + 0.5 + vert_extend, yend_top = n_rows + 0.5 + vert_extend,
  # bottom horizontal
  x_bottom = 0.5 - 0.3, xend_bottom = 0.5 - 0.3 + hor_arm,
  y_bottom = 0.5 - vert_extend, yend_bottom = 0.5 - vert_extend
)

# Right bracket `]`
right_bracket = tibble(
  # vertical line
  x = n_cols + 0.5 + 0.3, xend = n_cols + 0.5 + 0.3,
  y = 0.5 - vert_extend, yend = n_rows + 0.5 + vert_extend,
  # top horizontal
  x_top = n_cols + 0.5 + 0.3, xend_top = n_cols + 0.5 + 0.3 - hor_arm,
  y_top = n_rows + 0.5 + vert_extend, yend_top = n_rows + 0.5 + vert_extend,
  # bottom horizontal
  x_bottom = n_cols + 0.5 + 0.3, xend_bottom = n_cols + 0.5 + 0.3 - hor_arm,
  y_bottom = 0.5 - vert_extend, yend_bottom = 0.5 - vert_extend
)

# Plot
p2 = ggplot(pred_matrix, aes(x = col, y = row, fill = factor(subj), alpha = alpha)) + 
  geom_tile(color = "grey70", size = 0.5) +
  # Left bracket
  geom_segment(data = left_bracket, aes(x = x, xend = xend, y = y, yend = yend), inherit.aes = FALSE, size = 1) +
  geom_segment(data = left_bracket, aes(x = x_top, xend = xend_top, y = y_top, yend = yend_top), inherit.aes = FALSE, size = 1) +
  geom_segment(data = left_bracket, aes(x = x_bottom, xend = xend_bottom, y = y_bottom, yend = yend_bottom), inherit.aes = FALSE, size = 1) +
  # Right bracket
  geom_segment(data = right_bracket, aes(x = x, xend = xend, y = y, yend = yend), inherit.aes = FALSE, size = 1) +
  geom_segment(data = right_bracket, aes(x = x_top, xend = xend_top, y = y_top, yend = yend_top), inherit.aes = FALSE, size = 1) +
  geom_segment(data = right_bracket, aes(x = x_bottom, xend = xend_bottom, y = y_bottom, yend = yend_bottom), inherit.aes = FALSE, size = 1) +
  theme_minimal(base_family = "Source Sans Pro") +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank(),
    plot.background = element_rect(fill = "#FFFFFF", color = NA),
    plot.title = element_text(size = 36, face = "bold", hjust = 0.5)
  ) +
  # labs(title = "X") +
  theme(legend.position = "none") + 
  scale_fill_manual(values = c("#CBA052", "#4E97E0", "#008767")) +
  scale_y_reverse()

p2  = 
  p2 + 
  annotate(geom = "label", x = 5.5, y = 2.5, label = "Predictors from person A", color = "#CBA052", size = 8)  +
  annotate(geom = "label", x = 5.5, y = 7.5, label = "Predictors from person B", color = "#4E97E0", size = 8) +
  annotate(geom = "label", x = 5.5, y = 12.5, label = "Predictors from person C", color = "#008767", size = 8) 

p2a = arrow_plot + p2 + plot_layout(widths = c(0.1, 0.9))
```

```{r print arrow x }
# p1 + p2a + plot_layout(widths = c(1, 1))

plot_grid(p1, p2a, ncol = 2, align = "v", rel_widths = c(1,1))

```

---


### Fingerprints summarize predictors for a given lag and are different across individuals

```{r fprints 3}
#| cache: true 

s1_dens = 
 dens_df_s2_l15 %>% mutate(lag = "Lag = 0.15s") %>% 
  bind_rows(dens_df_s2_l30 %>% mutate(lag = "Lag = 0.30s"))

s2_dens = 
 dens_df_s4_l15 %>% mutate(lag = "Lag = 0.15s") %>% 
  bind_rows(dens_df_s4_l30 %>% mutate(lag = "Lag = 0.30s"))

s3_dens = 
 dens_df_s6_l15 %>% mutate(lag = "Lag = 0.15s") %>% 
  bind_rows(dens_df_s6_l30 %>% mutate(lag = "Lag = 0.30s"))

s1_dens %>% mutate(id = "Person A") %>% 
  bind_rows(s2_dens %>% mutate(id = "Person B")) %>% 
  bind_rows(s3_dens %>% mutate(id = "Person C")) %>%
  ggplot(aes(x=vm, y=lag_vm, color = density)) +
  geom_point(size = 0.9, alpha = 0.8) +
  facet_grid(id~lag) +
  scale_color_viridis(name = "Density", option = "B") +
  labs(x = "Acceleration (g)", y = "Lagged Acceleration (g)") +
  scale_x_continuous(limits = c(0,3)) +
  scale_y_continuous(limits = c(0,3)) 
```

---

### Fingerprints summarize predictors for a given lag and are different across individuals

<img src="figs/time_series2.gif" class="gif-inline">
<img src="figs/fingerprint3.gif" class="gif-inline">

---


### Model fitting 


```{r ymat2}
#| cache: true
n_rows = 35
n_cols = 10 

# Create a dummy data frame for tiles
pred_matrix = expand_grid(
  row = 1:n_rows,
  col = 1:n_cols
) %>% 
  mutate(subj = 
           case_when(row %in% c(1:10) ~ 1,
                     row %in% c(11:20) ~ 2,
                     row %in% c(21:30) ~ 3,
                     .default = NA_real_)) %>% 
  rowwise() %>% 
  mutate(alpha = runif(1, 0, 1)) %>% 
  ungroup() %>% 
  mutate(alpha = if_else(row %in% c(31:34), Inf, alpha))

left_bracket = tibble(
  # vertical line
  x = 0.5 - 0.3, xend = 0.5 - 0.3,
  y = 0.5 - vert_extend, yend = n_rows + 0.5 + vert_extend,
  # top horizontal
  x_top = 0.5 - 0.3, xend_top = 0.5 - 0.3 + hor_arm,
  y_top = n_rows + 0.5 + vert_extend, yend_top = n_rows + 0.5 + vert_extend,
  # bottom horizontal
  x_bottom = 0.5 - 0.3, xend_bottom = 0.5 - 0.3 + hor_arm,
  y_bottom = 0.5 - vert_extend, yend_bottom = 0.5 - vert_extend
)

# Right bracket `]`
right_bracket = tibble(
  # vertical line
  x = n_cols + 0.5 + 0.3, xend = n_cols + 0.5 + 0.3,
  y = 0.5 - vert_extend, yend = n_rows + 0.5 + vert_extend,
  # top horizontal
  x_top = n_cols + 0.5 + 0.3, xend_top = n_cols + 0.5 + 0.3 - hor_arm,
  y_top = n_rows + 0.5 + vert_extend, yend_top = n_rows + 0.5 + vert_extend,
  # bottom horizontal
  x_bottom = n_cols + 0.5 + 0.3, xend_bottom = n_cols + 0.5 + 0.3 - hor_arm,
  y_bottom = 0.5 - vert_extend, yend_bottom = 0.5 - vert_extend
)

p3n = ggplot(pred_matrix, aes(x = col, y = row, fill = factor(subj), alpha = alpha)) + 
  geom_tile(color = "#f6f5f3", size = 0.5) +
  # Left bracket
  geom_segment(data = left_bracket, aes(x = x, xend = xend, y = y, yend = yend), inherit.aes = FALSE, size = 1) +
  geom_segment(data = left_bracket, aes(x = x_top, xend = xend_top, y = y_top, yend = yend_top), inherit.aes = FALSE, size = 1) +
  geom_segment(data = left_bracket, aes(x = x_bottom, xend = xend_bottom, y = y_bottom, yend = yend_bottom), inherit.aes = FALSE, size = 1) +
  # Right bracket
  geom_segment(data = right_bracket, aes(x = x, xend = xend, y = y, yend = yend), inherit.aes = FALSE, size = 1) +
  geom_segment(data = right_bracket, aes(x = x_top, xend = xend_top, y = y_top, yend = yend_top), inherit.aes = FALSE, size = 1) +
  geom_segment(data = right_bracket, aes(x = x_bottom, xend = xend_bottom, y = y_bottom, yend = yend_bottom), inherit.aes = FALSE, size = 1) +
  theme_minimal(base_family = "Source Sans Pro") +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank(),
    plot.background = element_rect(fill = "#ffffff", color = NA),
    plot.title = element_text(size = 36, face = "bold", hjust = 0.5)
  ) +
  labs(title = "X") +
  theme(legend.position = "none") + 
  scale_fill_manual(values = c("#CBA052", "#4E97E0", "#008767")) +
  scale_y_reverse() +
  geom_tile(data = subset(pred_matrix, is.infinite(alpha)), fill = "#ffffff") +
  annotate(geom = "text", x = n_cols/2 + .35, y = 32.5, label = "...", size = 8, angle = 90) 



p3n  = p3n +
  annotate(geom = "label", x = 5.5, y = 3, label = "Predictors from person A",
           size = 5, color = "#CBA052") +
  annotate(geom = "label", x = 5.5, y = 14, label = "Predictors from person B", size = 5, color = "#4E97E0") +
  annotate(geom = "label", x = 5.5, y = 23, label = "Predictors from person C", size = 5, color = "#008767") +
  annotate(geom = "label", x = 5.5, y = 35, label = "Predictors from person n", size = 5) 
```

```{r y matrix updated}
#| cache: true
n_cols = 1
n_rows = 35

pred_matrix = expand_grid(
  row = 1:n_rows,
  col = 1:n_cols
) %>% 
  mutate(subj = 
           case_when(row %in% c(1:10) ~ 1,
                     row %in% c(11:20) ~ 2,
                     row %in% c(21:30) ~ 3,
                     TRUE ~ NA_real_)) 

left_bracket = tibble(
  # vertical line
  x = 0.5 - 0.3, xend = 0.5 - 0.3,
  y = 0.5 - vert_extend, yend = n_rows + 0.5 + vert_extend,
  # top horizontal
  x_top = 0.5 - 0.3, xend_top = 0.5 - 0.3 + hor_arm,
  y_top = n_rows + 0.5 + vert_extend, yend_top = n_rows + 0.5 + vert_extend,
  # bottom horizontal
  x_bottom = 0.5 - 0.3, xend_bottom = 0.5 - 0.3 + hor_arm,
  y_bottom = 0.5 - vert_extend, yend_bottom = 0.5 - vert_extend
)

# Right bracket `]`
right_bracket = tibble(
  # vertical line
  x = n_cols + 0.5 + 0.3, xend = n_cols + 0.5 + 0.3,
  y = 0.5 - vert_extend, yend = n_rows + 0.5 + vert_extend,
  # top horizontal
  x_top = n_cols + 0.5 + 0.3, xend_top = n_cols + 0.5 + 0.3 - hor_arm,
  y_top = n_rows + 0.5 + vert_extend, yend_top = n_rows + 0.5 + vert_extend,
  # bottom horizontal
  x_bottom = n_cols + 0.5 + 0.3, xend_bottom = n_cols + 0.5 + 0.3 - hor_arm,
  y_bottom = 0.5 - vert_extend, yend_bottom = 0.5 - vert_extend
)

p4 = pred_matrix %>% 
  mutate(outcome = case_when(subj == 1 ~ "1",
                             !is.na(subj) ~ "0",
                             is.na(subj) & row == 35 ~ "0",
                             .default = ".")) %>% 
  ggplot(aes(x = col, y = row, label = outcome, color = as.factor(subj))) + 
  geom_tile(color = NA, fill = NA, size = 0.5) +
  # geom_text(size = 3)  +
  scale_color_manual(values = c("#CBA052", "#4E97E0", "#008767")) +
  geom_segment(data = left_bracket, aes(x = x, xend = xend, y = y, yend = yend), inherit.aes = FALSE, size = 1) +
  geom_segment(data = left_bracket, aes(x = x_top, xend = xend_top, y = y_top, yend = yend_top), inherit.aes = FALSE, size = 1) +
  geom_segment(data = left_bracket, aes(x = x_bottom, xend = xend_bottom, y = y_bottom, yend = yend_bottom), inherit.aes = FALSE, size = 1) +
  # Right bracket
  geom_segment(data = right_bracket, aes(x = x, xend = xend, y = y, yend = yend), inherit.aes = FALSE, size = 1) +
  geom_segment(data = right_bracket, aes(x = x_top, xend = xend_top, y = y_top, yend = yend_top), inherit.aes = FALSE, size = 1) +
  geom_segment(data = right_bracket, aes(x = x_bottom, xend = xend_bottom, y = y_bottom, yend = yend_bottom), inherit.aes = FALSE, size = 1) +
  theme_minimal(base_family = "Source Sans Pro") +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank(),
    plot.background = element_rect(fill = "#ffffff", color = NA),
    plot.title = element_text(size = 36, face = "bold", hjust = 0.5)
  ) +
  labs(title = "Y") +
  theme(legend.position = "none") + 
  scale_y_reverse() 

p4 = 
  p4 +
  annotate(geom = "text", x = 1, y = 7, label = "1", size = 12, color = "#CBA052") +
  annotate(geom = "text", x = 1, y = 15, label = "0", size = 12) +
  annotate(geom = "text", x = 1, y = 19, label = ".", size = 12) +
  annotate(geom = "text", x = 1, y = 21, label = ".", size = 12) +
  annotate(geom = "text", x = 1, y = 23, label = ".", size = 12) +
  annotate(geom = "text", x = 1, y = 30, label = "0", size = 12) 

p4 + p3n + plot_layout(ncol = 2, widths = c(0.3, 1)) 
```

---

### Results in labeled datasets 

:::: {.columns}

::: {.column width="45%"}

**32 individuals, 6 minutes of walking each**

100\% rank-1 accuracy 
[@Koffman2023]

:::


::: {.column width="55%"}

**153 individuals, 3 minutes of walking each**

*Two sessions, at least 1 week apart* 


Rank-1 (rank-5) % accuracies 


+ Train and test on session 1
  + Logistic regression: 92 (97) 
  + <span style="color:#009E73;">XGBoost: 93 (99)</span>

+ Train on session 1, test on session 2 
  + Logistic regression: 41 (75)
  + <span style="color:#009E73;">XGBoost: 58 (78)</span>


[@Koffman2024]

:::

::::


# Can we identify someone from their walking pattern measured by a wrist-worn accelerometer in large, unlabeled data sets?

---


### NHANES data: recap 

+ $>15,000$ participants
+ $7$ days of wrist accelerometry
+ $10$Tb of data 
+ Open source processing pipeline 
+ Publicly available data repository 
+ **First** nationally representative estimate of steps in the US population using open source algorithms

![](figs/physionet.png){width=70%}
<div style=" position: absolute; bottom: 0.5em; right: -4em; font-size: 0.7em; color: #777; "> @physionet </div>

---

## Walking fingerprinting in NHANES 

<div style="font-size: 150%;">

**Process outline**

::: {.incremental}
+ Use algorithm to identify walking 
+ Partition data into train/test 
+ Fit models 
:::
</div> 

---

### Use algorithms to identify walking 

</br> 

**ADaptive Empirical Pattern Transformation (ADEPT)** [@Karas2019]

<div style="font-size: 1.8em;">

```{r adept}
#| eval: false
#| echo: true 

library(adept)
adept::segmentWalking(
  xyz, # data frame of tri-axial accelerometry (3 cols)
  xyz.fs = 100, # sample rate 
  template = templates # list of templates for pattern matching
)


```
 
</div> 

</br> 
</br> 


**stepcount** [@small2024]

<div style="font-size: 1.8em;">

```{r sc}
#| eval: false
#| echo: true 

devtools::install_github("jhuwit/stepcount")
library(stepcount)
stepcount::stepcount(file = sample_data, model_type = "ssl")
```


</div>

---

### Use algorithms to identify walking 

```{r walking bouts}
#| cache: true 


segments_ad = 
  segments %>% 
  group_by(id, day) %>% 
  summarize(total_seconds = sum(n_seconds),
            longest_bout = max(n_seconds)) %>% 
  ungroup() %>% 
  mutate(method = "adept")
segments_scs = 
  segments_sc %>% 
  group_by(id, day) %>% 
  summarize(total_seconds = sum(n_seconds),
            longest_bout = max(n_seconds)) %>% 
  ungroup() %>% 
  mutate(method = "stepcount")

total = segments_ad %>% bind_rows(segments_scs)

ad_pct = 
  segments_ad %>% 
  group_by(id) %>% 
  summarize(total_seconds = sum(total_seconds)) %>% 
  mutate(min3 = total_seconds >= 60 * 3) %>% 
  summarize(min3 = sum(min3),
            n = n(),
            pct = min3/n * 100) %>% 
  pull(pct)

sc_pct = 
  segments_scs %>% 
  group_by(id) %>% 
  summarize(total_seconds = sum(total_seconds)) %>% 
  mutate(min3 = total_seconds >= 60 * 30) %>% 
  summarize(min3 = sum(min3),
            n = n(),
            pct = min3/n * 100) %>% 
  pull(pct)

p1 = total %>% 
  mutate(method = factor(method, labels = c("ADEPT", "stepcount"))) %>% 
  ggplot(aes(x = total_seconds / 60, fill = method)) + 
  geom_histogram(color = "black") + 
  facet_wrap(.~method) +
  scale_x_continuous(limits = c(0, 240),
                     breaks = seq(0, 240, 30),
                     labels = seq(0, 4, 0.5)) +
  labs(y = "Number of participant-days", x = "Hours walking per day",
       title = "Walking per day and participant by method") +
  theme(legend.position = "none") +
  scale_fill_manual(values = c("#A45C98", "#008767")) +
  scale_y_continuous(limits = c(0, 30000), breaks=seq(0, 30000, 10000))

p2 = total %>% 
  mutate(method = factor(method, labels = c("ADEPT", "stepcount"))) %>% 
  group_by(method, id) %>% 
  summarize(total = sum(total_seconds), .groups = "drop") %>% 
  ggplot(aes(x = total / (60 * 60), fill = method)) + 
  geom_histogram(color = "black") + 
  facet_wrap(.~method) +
  scale_x_continuous(limits = c(0, 40),
                     breaks = seq(0, 40, 10)) +
  labs(y = "Number of participants", x = "Hours walking",
       title = "Walking time per participant by method") +
  theme(legend.position = "none") +
  scale_fill_manual(values = c("#A45C98", "#008767")) +
  scale_y_continuous(limits = c(0, 3500), breaks=seq(0, 3500, 500))

p2 = total %>% 
  mutate(method = factor(method, labels = c("ADEPT", "stepcount"))) %>% 
  group_by(method, id) %>% 
  summarize(total = sum(total_seconds), .groups = "drop") %>% 
  ggplot(aes(x = total / (60 * 60), fill = method)) + 
  geom_histogram(color = "black") + 
  facet_wrap(.~method, scales ="free") +
  labs(y = "Number of participants", x = "Hours walking",
       title = "Walking time per participant by method") +
  theme(legend.position = "none") +
  scale_fill_manual(values = c("#A45C98", "#008767")) +
  scale_x_continuous(breaks=seq(0, 50, 5))

p2


```



---

### Use algorithms to identify walking 

```{r wb2}
p2 + 
  geom_label(data = tibble(method = "ADEPT", total = 10),
             aes(x = total, y = 4000, label = "85% of participants have at least\n3 minutes of ADEPT-identified walking"), color = "#F56600", size = 4, inherit.aes = FALSE)

```

---

### Use algorithms to identify walking 

```{r wb3}
p2 + 
  geom_label(data = tibble(method = "ADEPT", total = 10),
             aes(x = total, y = 4000, label = "85% of participants have at least\n3 minutes of ADEPT-identified walking"), color = "#F56600", size = 4, inherit.aes = FALSE) +
  geom_label(data = tibble(method = "stepcount", total = 30),
             aes(x = total, y = 1000, label = "98% of participants have at least\n30 minutes of stepcount-identified walking"), color = "#F56600", size = 4, inherit.aes = FALSE) 

```

---

### Partition data into train/test 


```{r train test}
#| cache: true 


data2 =
  tibble(day = c(1, 2, 3, 4),
         start = c(0, NA, NA, 20),
         end = c(135,NA, NA, 65),
         type = c("train", "train", "train", "test"))

df =
  expand_grid(day = 1:4,
              minute = 1:180) %>%
  mutate(rn = row_number())

all_inds = sample(1:720, 180, replace = FALSE)
train_inds = sample(all_inds, 180*.75, replace = FALSE)
test_inds = setdiff(all_inds, train_inds)

df =
  df %>%
  mutate(type = case_when(
    rn %in% train_inds ~ "train",
    rn %in% test_inds ~ "test",
    .default = NA_character_
  ),
  start = if_else(!is.na(type), minute, NA_real_),
  end = start + 1)


p = df %>%
  mutate(paradigm = "random") %>%
  bind_rows(data2 %>% mutate(paradigm = "temporal")) %>%
  mutate(
    type = factor(type, levels = c("train", "test")),
    y = as.numeric(factor(paradigm, levels = c("temporal", "random"))),
    ymin = y - 0.3,
    ymax = y + 0.3,
    day = paste0("Day ", day)
  ) %>%
  ggplot(aes(xmin = start, xmax = end, ymin = ymin, ymax = ymax, fill = type)) +
  geom_rect() +
  scale_y_continuous(breaks = 1:2, expand = c(0.05, 0.05),
                     labels = c("Temporal", "Random")) +
  facet_grid(~day) +
  # scale_y_continuous(limits = c(0, 1), breaks = NULL) +
  scale_x_continuous(breaks=seq(0,180,60),
                     labels =seq(0,3,1),
                     limits=c(0,180)) +
  labs(x = "Time") +
  scale_fill_manual(values = c("#4E97E0", "#F56600"), na.translate = FALSE, name = "Data", labels = c("Train", "Test")) +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.y = element_blank())


p
```

---



### Fit models

**Questions** 

::: {.incremental}
+ How important is sample size? 
  + Fit on subgroups of size $n=100$ and entire $N$ 
+ How important is walking identification algorithm accuracy? 
  + Compare ADEPT, stepcount on same individuals 
+ How important is length of training data? 
  + Train on 3 min vs. 30 min.
+ How important is train/test partition type? 
  + Compare random vs. temporal
+ How important is model choice? 
  + Compare logistic regression, XGBoost, random forest
+ Can we improve logistic regression? 
  + Weighting, oversampling 

::: 

---

### Sample size 

```{r ss} 
#| cache: true 


lab_df =
  all_logistic %>%
  mutate(paradigm = factor(paradigm, labels = c("Random", "Temporal"))) %>%
  group_by(n, paradigm) %>%
  summarize(across(starts_with("rank"), median)) %>%
  pivot_longer(cols = contains("rank"), names_to = "metric", values_to = "value") %>%
  ungroup() %>%
  filter(n == 5000) %>%
  mutate(metric_lab =
           case_when(metric == "rank1" ~ "Rank 1",
                     metric == "rank5" ~ "Rank 5",
                     metric == "rank1pct" ~ "Rank 1%",
                     .default = "Rank 5%"))
p = all_logistic %>%
  mutate(paradigm = factor(paradigm, labels = c("Random", "Temporal"))) %>%
  group_by(n, paradigm) %>%
  summarize(across(starts_with("rank"), median)) %>%
  pivot_longer(cols = contains("rank"), names_to = "metric", values_to = "value") %>%
  # mutate(name = factor(name, labels = c("Rank 1", "Rank 5"))) %>%
  ggplot(aes(x = n, y = value, color = metric, group = metric)) +
  geom_jitter(width = 25, size = 3) +
  geom_line(linewidth = 1.4) +
  facet_grid(.~paradigm, scales = "free_x") +
  scale_x_continuous(breaks=c(100, 500, 1000, 2500, 5000, 10000, 10770, 13367),
                     labels = c(1, 5, 10, 25, 50, 100, 108, 133)) +
  scale_y_continuous(breaks=seq(0,100,10)) +
  theme(panel.grid.minor = element_blank(),
        legend.position = "none",
        strip.text = element_text(size = 12),
        axis.text = element_text(size = 12),
        legend.text = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.title = element_text(size = 14)) +
  geom_label(data = lab_df,
             aes(x = n, y = value, label = metric_lab, color = metric),
             hjust = -.5, size = 4) +
  labs(x = "Number of Participants (x100)", y = "Median Accuracy") +
  scale_color_manual(values = c("#F56600", "#CBA052", "#002D72", "#4E97E0"),
                     labels = c("Rank 1", "Rank 1%", "Rank 5", "Rank 5%"), name = "Metric")

p = all_logistic %>%
  mutate(paradigm = factor(paradigm, labels = c("Random", "Temporal"))) %>%
  group_by(n, paradigm) %>%
  summarize(across(starts_with("rank"), median)) %>%
  pivot_longer(cols = contains("rank"), names_to = "metric", values_to = "value") %>%
  filter(paradigm == "Random") %>% 
  # mutate(name = factor(name, labels = c("Rank 1", "Rank 5"))) %>%
  ggplot(aes(x = n, y = value, color = metric, group = metric)) +
  geom_jitter(width = 25, size = 3) +
  geom_line(linewidth = 1.4) +
  # facet_grid(.~paradigm, scales = "free_x") +
  scale_x_continuous(breaks=c(100, 500, 1000, 2500, 5000, 10000, 13367),
                     labels = c(1, 5, 10, 25, 50, 100,  133)) +
  scale_y_continuous(breaks=seq(0,100,10)) +
  theme(panel.grid.minor = element_blank(),
        legend.position = "none",
        strip.text = element_text(size = 12),
        axis.text = element_text(size = 12),
        legend.text = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.title = element_text(size = 14)) +
  geom_label(data = lab_df %>% filter(paradigm == "Random"),
             aes(x = n, y = value, label = metric_lab, color = metric),
             hjust = -.5, size = 4) +
  labs(x = "Number of Participants (x100)", y = "Median Accuracy",
       title = "Accuracy by sample size",
       subtitle = "ADEPT, 3 min of data per ppt, random train/test") +
  scale_color_manual(values = c("#F56600", "#CBA052", "#002D72", "#4E97E0"),
                     labels = c("Rank 1", "Rank 1%", "Rank 5", "Rank 5%"), name = "Metric")
p
```


---

### Algorithm 

```{r algo res}
#| cache: true 
# for n = 100, show boxplots of sc vs. adept 

ad_100 = read_rds(here::here("results", "prediction_res_100.rds"))
sc_100 = read_rds(here::here("results", "prediction_res_scs_100.rds"))

ad_100 %>% 
  mutate(algorithm = "ADEPT") %>% 
  bind_rows(sc_100 %>% mutate(algorithm = "stepcount")) %>% 
  ggplot(aes(x = algorithm, y = rank1, fill = algorithm)) +
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(width = .1, size = .5, alpha = 0.5) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, 10)) +
  scale_fill_manual(values = c("#A45C98", "#008767")) +
  theme(legend.position = "none") + 
  labs(x = "Algorithm", y = "Rank 1 Accuracy", title = "ADEPT vs. stepcount", subtitle = "3 min of data per ppt, subgroups of n = 100, random train/test") 
```

---

### Length of data 

```{r length res}
#| cache: true 
# for n = 100, show boxplots of sc vs. adept 

ad_100 = read_rds(here::here("results", "prediction_res_100.rds"))
ad_100_long = read_rds(here::here("results", "prediction_res_100_30min.rds"))


ad_100 %>% 
  mutate(len = "3 min") %>% 
  bind_rows(ad_100_long %>% mutate(len = "30 min")) %>% 
  ggplot(aes(x = len, y = rank1, fill = len)) +
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(width = .1, size = .5, alpha = 0.5) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, 10)) +
  scale_fill_manual(values = c("#4E97E0", "#002D72")) +
  theme(legend.position = "none") + 
  labs(x = "Length of data", y = "Rank 1 Accuracy", title = "3 min vs. 30 min", subtitle = "ADEPT, subgroups of n = 100, random train/test") 

# for n = 100, show boxplots for 3 vs. 30 min, ADEPT only 
```

---

### Train/test partition 

```{r tt res}
#| cache: true 


# random vs temporal boxplots 
ad_100 = read_rds(here::here("results", "prediction_res_100.rds"))
ad_100t = read_rds(here::here("results", "prediction_res_temporal2_100.rds"))

ad_100 %>% 
  mutate(len = "Random") %>% 
  bind_rows(ad_100t %>% mutate(len = "Temporal")) %>% 
  ggplot(aes(x = len, y = rank1, fill = len)) +
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(width = .1, size = .5, alpha = 0.5) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, 10)) +
  scale_fill_manual(values = c("#CBA052", "#F56600")) +
  theme(legend.position = "none") + 
  labs(x = "Train/test paradigm", y = "Rank 1 Accuracy", title = "Random vs. temporal", subtitle = "ADEPT, subgroups of n = 100, 3 min of data per ppt.") 

```

---

### Model choice 

```{r rf vs log}
#| cache: true 


# boxplots for n =100, n = 500? 
ad_500 = read_rds(here::here("results", "prediction_res_500.rds"))
rf_500 = read_rds(here::here("results", "prediction_res_500rf.rds")) %>% 
  mutate(fold= as.character(fold))
xgb_500 = read_rds(here::here("results", "prediction_res_500xgb.rds")) %>%
  mutate(fold= as.character(fold))

ad_100 = read_rds(here::here("results", "prediction_res_100.rds"))
rf_100 = read_rds(here::here("results", "prediction_res_100rf.rds")) %>% 
  mutate(fold= as.character(fold))
xgb_100 = read_rds(here::here("results", "prediction_res_100xgb.rds")) %>%
  mutate(fold= as.character(fold))


res_100 = ad_100 %>% 
  mutate(len = "Logistic reg.") %>% 
  bind_rows(rf_100 %>% mutate(len = "Random Forest")) %>% 
  bind_rows(xgb_100 %>% mutate(len = "XGBoost")) %>% 
  mutate(n = "n = 100")

res_500 = ad_500 %>% 
  mutate(len = "Logistic reg.") %>% 
  bind_rows(rf_500 %>% mutate(len = "Random Forest")) %>% 
  bind_rows(xgb_500 %>% mutate(len = "XGBoost")) %>% 
  mutate(n = "n = 500") %>% 
  mutate(rank1 = rank1 / 500 * 100) 

res_100 %>% 
  bind_rows(res_500) %>% 
  ggplot(aes(x = len, y = rank1, fill = len)) +
  geom_boxplot(outlier.shape = NA) + 
  facet_grid(.~n) +
  geom_jitter(width = .1, size = .5, alpha = 0.5) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, 10)) +
  scale_fill_manual(values = c("#A45C98", "#86C8BC", "#F1C400")) +
  theme(legend.position = "none") + 
  labs(x = "Model", y = "Rank 1 Accuracy", title = "Model choices", subtitle = "ADEPT, 3 min of data per ppt.") 

```

---

### Model improvements 


<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

<style>
  body {
    font-family: 'Source Sans Pro', sans-serif;
    margin: 40px; /* Added margin to body so the big table doesn't hit edges */
  }
  table {
    border-collapse: collapse;
    width: 100%;
    margin: 20px 0;
    font-size: 35px; /* Increased size by ~50% */
    text-align: left;
  }
  th {
    border-top: 3px solid #333; /* Made border slightly thicker to match text */
    border-bottom: 2px solid #333;
    padding: 16px 12px; /* Increased padding */
    font-weight: 700;
  }
  td {
    padding: 12px; /* Increased padding */
    border-bottom: 1px solid #ddd;
    font-weight: 400;
  }
  /* Center align numerical columns */
  td:nth-child(n+3), th:nth-child(n+3) {
    text-align: center;
  }
  /* Style for the grouping column */
  .group-header {
    font-weight: 700;
    vertical-align: middle;
    background-color: #f9f9f9;
    padding-right: 20px;
  }
  /* Bottom border for the whole table */
  tr:last-child td {
    border-bottom: 3px solid #333;
  }
  caption {
    caption-side: bottom;
    padding-top: 15px;
    font-size: 35px; /* Also increased caption size */
    font-style: italic;
    color: #666;
    text-align: left;
  }
</style>
</head>
<body>

<table>
  <thead>
    <tr>
      <th>Dataset</th>
      <th>Model</th>
      <th>Rank 1</th>
      <th>Rank 1%</th>
      <th>Rank 5</th>
      <th>Rank 5%</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td rowspan="4" class="group-header">Random<br><span style="font-weight:normal; font-style:italic;">(n=13,367)</span></td>
      <td>Logistic</td>
      <td>9.7</td>
      <td>68</td>
      <td>21</td>
      <td>93</td>
    </tr>
    <tr>
      <td>Oversampled at 10%</td>
      <td><strong>41</strong></td>
      <td>68</td>
      <td><strong>95</strong></td>
      <td>99</td>
    </tr>
    <tr>
      <td>Weighted</td>
      <td>34</td>
      <td><strong>96</strong></td>
      <td>61</td>
      <td><strong>100</strong></td>
    </tr>
    <tr>
      <td>Two-stage</td>
      <td>20</td>
      <td>68</td>
      <td>37</td>
      <td>93</td>
    </tr>
    
    <tr>
      <td rowspan="4" class="group-header">Temporal<br><span style="font-weight:normal; font-style:italic;">(n=10,770)</span></td>
      <td>Logistic</td>
      <td>0.028</td>
      <td>26</td>
      <td>5.1</td>
      <td>49</td>
    </tr>
    <tr>
      <td>Oversampled at 10%</td>
      <td>4.3</td>
      <td><strong>32</strong></td>
      <td><strong>10</strong></td>
      <td><strong>52</strong></td>
    </tr>
    <tr>
      <td>Weighted</td>
      <td>1.8</td>
      <td>23</td>
      <td>5.1</td>
      <td>45</td>
    </tr>
    <tr>
      <td>Two-stage</td>
      <td><strong>5.2</strong></td>
      <td>26</td>
      <td>10</td>
      <td>49</td>
    </tr>
  </tbody>
  <caption>
    Rank 1, rank 1%, rank 5, rank 5% accuracies of different model types on the entire population for each model. The best model in each category is bolded.
  </caption>
</table>


---

### Fingerprints

```{r fprints}
#| cache: true
plot_list = map(.x = c(82367, 78466, 66810, 79001, 79235), .f = make_plot)

p1 = plot_list[[1]] + plot_list[[2]] + plot_list[[3]]  +
  plot_layout(nrow = 1, axes = 'collect') + plot_annotation(title = "Well-Predicted Participants")
p1 
```

---

### Fingerprints 

```{r fp2}
#| cache: true
plot_list2 = map(.x = c(69878, 72735, 65584, 73266, 72232), .f = make_plot)

p2 = plot_list2[[1]] + plot_list2[[2]] + plot_list2[[3]]  +
  plot_layout(nrow = 1, axes = 'collect') + plot_annotation(title = "Poorly-Predicted Participants")
p2
```


---

## Summary 
<br> 
<div style="font-size: 150%;">

+ We can identify individuals from their walking patterns in large, unlabeled datasets using predictors derived from acceleration, lag acceleration
+ Performance depends on sample size, walking identification algorithm, train/test partition, length of training data, model choice 
+ Preprint on arXiv [@nhanes_fprint]
</div>

---

## Future directions 

<br> 
<div style="font-size: 150%;">
+ Using CNN/deep learning models 
+ Using fingerprint as the outcome instead of predictor, investigating change over time or association with health status/mortality 
</div>
---

## Thank you!

<br>
<div style="font-size: 150%;">

- Link to slides: [tinyurl.com/koff-enar25](tinyurl.com/koff-enar25) 
- Email: [lkoffma2@jh.edu](lkoffma2@jh.edu)
- Website: [lilykoff.com](lilykoff.com)
- Github: [github.com/lilykoff](github.com/lilykoff)
</div>
<br>

![](figs/qr.png){width=35%}

---

## References

::: {#refs}
:::

